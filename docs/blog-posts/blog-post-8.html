<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matthew B. Jané">
<meta name="dcterms.date" content="2024-09-24">
<meta name="description" content="A GAM is a linear or generalized linear model that allows you to model non-linear relationships using splines, smooth functions that allows to model the “wiggliness” in the data. To my knowledge there is little/nothing out there regarding the use of GAMs in a meta-analysis context.">

<title>Generalized Additive Models (GAMs) for Meta-Regression using brms – Matthew B. Jané</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="..//webLogoFavicon2.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Generalized Additive Models (GAMs) for Meta-Regression using brms – Matthew B. Jané">
<meta property="og:description" content="A GAM is a linear or generalized linear model that allows you to model non-linear relationships using splines, smooth functions that allows to model the “wiggliness” in the data. To my knowledge there is little/nothing out there regarding the use of GAMs in a meta-analysis context.">
<meta property="og:image" content="https://matthewbjane.com/blog-posts/blog-image.png">
<meta property="og:site_name" content="Matthew B. Jané">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="7206">
<meta property="og:image:width" content="10817">
<meta name="twitter:title" content="Generalized Additive Models (GAMs) for Meta-Regression using brms – Matthew B. Jané">
<meta name="twitter:description" content="A GAM is a linear or generalized linear model that allows you to model non-linear relationships using splines, smooth functions that allows to model the “wiggliness” in the data. To my knowledge there is little/nothing out there regarding the use of GAMs in a meta-analysis context.">
<meta name="twitter:image" content="https://matthewbjane.com/blog-posts/blog-image.png">
<meta name="twitter:creator" content="@MatthewBJane">
<meta name="twitter:image-height" content="7206">
<meta name="twitter:image-width" content="10817">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../webLogoFavicon2.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Matthew B. Jané</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Meta-Analysis Magic</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../CV.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Books.html"> 
<span class="menu-text">Books</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Consulting.html"> 
<span class="menu-text">Consulting</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/MatthewBJane"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.twitter.com/MatthewBJane"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-meta-regression" id="toc-what-is-meta-regression" class="nav-link active" data-scroll-target="#what-is-meta-regression">What is Meta-regression?</a></li>
  <li><a href="#what-would-a-meta-analytic-gam-look-like" id="toc-what-would-a-meta-analytic-gam-look-like" class="nav-link" data-scroll-target="#what-would-a-meta-analytic-gam-look-like">What would a meta-analytic GAM look like?</a></li>
  <li><a href="#loading-in-packages" id="toc-loading-in-packages" class="nav-link" data-scroll-target="#loading-in-packages">Loading in packages</a></li>
  <li><a href="#non-linear-data" id="toc-non-linear-data" class="nav-link" data-scroll-target="#non-linear-data">Non-linear Data</a></li>
  <li><a href="#constructing-the-brms-model" id="toc-constructing-the-brms-model" class="nav-link" data-scroll-target="#constructing-the-brms-model">Constructing the <code>brms</code> model</a></li>
  <li><a href="#predictive-check" id="toc-predictive-check" class="nav-link" data-scroll-target="#predictive-check">Predictive Check</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  <li><a href="#citing-r-packages" id="toc-citing-r-packages" class="nav-link" data-scroll-target="#citing-r-packages">Citing R packages</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Generalized Additive Models (GAMs) for Meta-Regression using <code>brms</code></h1>
  <div class="quarto-categories">
    <div class="quarto-category">Generalized Additive Models</div>
    <div class="quarto-category">Meta-regression</div>
  </div>
  </div>

<div>
  <div class="description">
    A GAM is a linear or generalized linear model that allows you to model non-linear relationships using splines, smooth functions that allows to model the “wiggliness” in the data. To my knowledge there is little/nothing out there regarding the use of GAMs in a meta-analysis context.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Matthew B. Jané </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 24, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<a href="https://www.buymeacoffee.com/matthewbjane"><img src="https://img.buymeacoffee.com/button-api/?text=Support my work&amp;emoji=☕&amp;slug=matthewbjane&amp;button_colour=ed5c9b&amp;font_colour=ffffff&amp;font_family=Arial&amp;outline_colour=ffffff&amp;coffee_colour=ffffff"></a>
<p><br></p>
<section id="what-is-meta-regression" class="level2">
<h2 class="anchored" data-anchor-id="what-is-meta-regression">What is Meta-regression?</h2>
<p>Meta-regression is a modeling approach used in meta-analysis to see how effect sizes vary across studies. For example, let’s say we want to know the effect of some drug on disease remission, but the effect sizes are highly heterogenous (studies use different methods, sample from different populations, etc. and thus have different estimands). We may want to know what aspects of these studies cause differences in their resulting effects? If different studies use a different doseage amount then we may hypothesize that dose will account for some of that heterogeneity in effects. Doseage is what we would call a <strong>moderator</strong> of the effect size (moderator is analogous to a predictor in a traditional regression). Meta-regression is like any regression model with the only difference that the data points represent entire studies and that studies are weighted such that more precise studies (i.e., larger sample sizes/smaller standard errors) are preferentially weighted. The regression line will estimate the <strong>conditional mean</strong> effect size.</p>
<p>Let’s visualize this example by running a meta-regression and creating a bubble plot (a scatter plot, but the data points are sized relative to the precision of the study). The effect size is the log risk ratio between treatment and control groups,</p>
<p><span class="math display">\[
\ln RR = \ln \frac{p_T}{p_C},
\]</span> where <span class="math inline">\(p_T\)</span> and <span class="math inline">\(p_C\)</span> are the proportions of individuals in remission within the treatment and control group, respectively. We will then see how the doseage moderates the <span class="math inline">\(\ln RR\)</span> across studies. In R, we can use the <code>metafor</code> <span class="citation" data-cites="metafor">(<a href="#ref-metafor" role="doc-biblioref">Viechtbauer 2010</a>)</span> package to fit a meta-regression.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(metafor)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">escalc</span>(<span class="at">measure =</span> <span class="st">"RR"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>              <span class="co"># data set loaded in from metafor package</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> dat.viechtbauer2021,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>              <span class="co"># treatment/control number of people in remission</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">ai =</span> xTi, <span class="at">ci =</span> xCi,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>              <span class="co"># treatment/control group sample size in</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">n1 =</span> nTi, <span class="at">n2 =</span> nCi,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>              <span class="co"># label effect size and sampling variance (se^2)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">var.names =</span> <span class="fu">c</span>(<span class="st">"lnRR"</span>, <span class="st">"v"</span>))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>mdl <span class="ot">&lt;-</span> <span class="fu">rma</span>(lnRR <span class="sc">~</span> dose, </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">vi =</span> v,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> dat)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plot model</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">regplot</span>(mdl,<span class="at">refline =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="blog-post-8_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>We see a very strong relationship between the effect size and the dosage amount.</p>
</section>
<section id="what-would-a-meta-analytic-gam-look-like" class="level2">
<h2 class="anchored" data-anchor-id="what-would-a-meta-analytic-gam-look-like">What would a meta-analytic GAM look like?</h2>
<p><strong>This brief intro section is a sort of a meta-analytic adaptation of a <a href="https://m-clark.github.io/generalized-additive-models/building_gam.html#what-is-a-gam">section</a> of Michael Clark’s online text “Generalized Additive Models”.</strong></p>
<p>In our example, we used a linear meta-regression so let us define a simple linear meta-regression model mathematically. An observed (arbitrary) effect size <span class="math inline">\(d_i\)</span> from study <span class="math inline">\(i\)</span> is expressed as,</p>
<p><span class="math display">\[
d_i = \underset{_\textrm{intercept}}{b_0} + \overset{^\textrm{moderator effect}}{b_1M_i} + \underset{_\textrm{true effect variability}}{u_i} + \overset{^\textrm{sampling error}}{\varepsilon_i}.
\]</span> The first three terms in the equation is what defines the true effect size <span class="math inline">\(\delta_i\)</span> for study <span class="math inline">\(i\)</span> and the last term denotes sampling error which is what distinguishes the observed effect size <span class="math inline">\(d_i\)</span> from the true effect size <span class="math inline">\(\delta_i\)</span>. The true effect size is conditionally distributed as,</p>
<p><span class="math display">\[
\delta_i \mid M_i \sim \mathcal{N}\left(b_0 + b_1M_i\, ,\, \tau^2\right)
\]</span> Where <span class="math inline">\(\tau^2\)</span> is the residual variance in true effects (i.e., <span class="math inline">\(\tau^2 = \mathrm{var}(u_i)\)</span>). We can see that the conditional expectation of true effects is a linear function of the moderator variable <span class="math inline">\(\mathbb{E}[\delta_i \mid M] = b_0 + b_1M_i\)</span>. But we don’t have to model the conditional mean as linear. If the data appears non-linear we can instead model it as some smooth function <span class="math inline">\(f\)</span> such that the conditional mean has some non-linear functional form,</p>
<p><span class="math display">\[
\delta_i \mid M_i \sim \mathcal{N}\left(f(M_i),\, \tau^2\right).
\]</span></p>
<p>For GAMs we elect to choose a space of functions (e.g., cubic splines) called a <strong>basis</strong>. A function within the function space can be expressed as a linear combination of basis functions. Essentially, we want to estimate this “big” function with with a series of known “smaller” functions. For our case, the function <span class="math inline">\(f(M_i)\)</span> can be expressed as, <span class="math inline">\(f(M_i) = \sum^m_{q=1} b_q\xi_q(M_i)\)</span>, where <span class="math inline">\(\xi_q\)</span> are basis functions. Therefore the conditional distribution of true effects is now given by,</p>
<p><span class="math display">\[
\delta_i \mid M_i \sim \mathcal{N}\left(\sum^m_{q=1} b_q\xi_q(M_i),\, \tau^2\right).
\]</span></p>
<p>The conditional expectation of true effects now can have a lot of flexibility. Note that we do not want to try to interpret the regression coefficients <span class="math inline">\(b_q\)</span> of those smaller basis functions, instead we want to interpret the bigger function which is estimating the conditional mean of true effects. To estimate the conditional expectation, GAMs utilize <strong>penalized splines</strong> which penalizes the function for being too “wiggly” so as to maintain a parsimonious model. The number of knots (i.e., the joints/abscissa of the “big” function) also does not have to be set manually like they do in other spline models.</p>
</section>
<section id="loading-in-packages" class="level2">
<h2 class="anchored" data-anchor-id="loading-in-packages">Loading in packages</h2>
<p>We will need the following packages before we begin.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelr)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="non-linear-data" class="level2">
<h2 class="anchored" data-anchor-id="non-linear-data">Non-linear Data</h2>
<p>We can use some made up non-linear data created by Wolfgang Viechtbauer in his <a href="https://www.metafor-project.org/doku.php/tips:non_linear_meta_regression">tutorial</a> on spline meta-regression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">structure</span>(<span class="fu">list</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># effect size data</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">yi =</span> <span class="fu">c</span>(<span class="fl">0.99</span>, <span class="fl">0.54</span>, <span class="sc">-</span><span class="fl">0.01</span>, <span class="fl">1.29</span>, <span class="fl">0.66</span>, <span class="sc">-</span><span class="fl">0.12</span>, <span class="fl">1.18</span>,<span class="sc">-</span><span class="fl">0.23</span>, <span class="fl">0.03</span>, <span class="fl">0.73</span>, <span class="fl">1.27</span>, <span class="fl">0.38</span>, <span class="sc">-</span><span class="fl">0.19</span>, <span class="fl">0.01</span>, <span class="fl">0.31</span>, <span class="fl">1.41</span>, <span class="fl">1.32</span>, <span class="fl">1.22</span>, <span class="fl">1.24</span>,<span class="sc">-</span><span class="fl">0.05</span>, <span class="fl">1.17</span>, <span class="sc">-</span><span class="fl">0.17</span>, <span class="fl">1.29</span>, <span class="sc">-</span><span class="fl">0.07</span>, <span class="fl">0.04</span>, <span class="fl">1.03</span>, <span class="sc">-</span><span class="fl">0.16</span>, <span class="fl">1.25</span>, <span class="fl">0.27</span>, <span class="fl">0.27</span>, <span class="fl">0.07</span>,<span class="fl">0.02</span>, <span class="fl">0.7</span>, <span class="fl">1.64</span>, <span class="fl">1.66</span>, <span class="fl">1.4</span>, <span class="fl">0.76</span>, <span class="fl">0.8</span>, <span class="fl">1.91</span>, <span class="fl">1.27</span>, <span class="fl">0.62</span>, <span class="sc">-</span><span class="fl">0.29</span>, <span class="fl">0.17</span>, <span class="fl">1.05</span>,<span class="sc">-</span><span class="fl">0.34</span>, <span class="sc">-</span><span class="fl">0.21</span>, <span class="fl">1.24</span>, <span class="fl">0.2</span>, <span class="fl">0.07</span>, <span class="fl">0.21</span>, <span class="fl">0.95</span>, <span class="fl">1.71</span>, <span class="sc">-</span><span class="fl">0.11</span>, <span class="fl">0.17</span>, <span class="fl">0.24</span>, <span class="fl">0.78</span>,<span class="fl">1.04</span>, <span class="fl">0.2</span>, <span class="fl">0.93</span>, <span class="dv">1</span>, <span class="fl">0.77</span>, <span class="fl">0.47</span>, <span class="fl">1.04</span>, <span class="fl">0.22</span>, <span class="fl">1.42</span>, <span class="fl">1.24</span>, <span class="fl">0.15</span>, <span class="sc">-</span><span class="fl">0.53</span>, <span class="fl">0.73</span>,<span class="fl">0.98</span>, <span class="fl">1.43</span>, <span class="fl">0.35</span>, <span class="fl">0.64</span>, <span class="sc">-</span><span class="fl">0.09</span>, <span class="fl">1.06</span>, <span class="fl">0.36</span>, <span class="fl">0.65</span>, <span class="fl">1.05</span>, <span class="fl">0.97</span>, <span class="fl">1.28</span>), </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># standard error</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sei =</span> <span class="fu">sqrt</span>(<span class="fu">c</span>(<span class="fl">0.018</span>, <span class="fl">0.042</span>, <span class="fl">0.031</span>, <span class="fl">0.022</span>, <span class="fl">0.016</span>, <span class="fl">0.013</span>, <span class="fl">0.066</span>, <span class="fl">0.043</span>, <span class="fl">0.092</span>, <span class="fl">0.009</span>,<span class="fl">0.018</span>, <span class="fl">0.034</span>, <span class="fl">0.005</span>, <span class="fl">0.005</span>, <span class="fl">0.015</span>, <span class="fl">0.155</span>, <span class="fl">0.004</span>, <span class="fl">0.124</span>, <span class="fl">0.048</span>, <span class="fl">0.006</span>, <span class="fl">0.134</span>,<span class="fl">0.022</span>, <span class="fl">0.004</span>, <span class="fl">0.043</span>, <span class="fl">0.071</span>, <span class="fl">0.01</span>, <span class="fl">0.006</span>, <span class="fl">0.128</span>, <span class="fl">0.1</span>, <span class="fl">0.156</span>, <span class="fl">0.058</span>, <span class="fl">0.044</span>,<span class="fl">0.098</span>, <span class="fl">0.154</span>, <span class="fl">0.117</span>, <span class="fl">0.013</span>, <span class="fl">0.055</span>, <span class="fl">0.034</span>, <span class="fl">0.152</span>, <span class="fl">0.022</span>, <span class="fl">0.134</span>, <span class="fl">0.038</span>, <span class="fl">0.119</span>,<span class="fl">0.145</span>, <span class="fl">0.037</span>, <span class="fl">0.123</span>, <span class="fl">0.124</span>, <span class="fl">0.081</span>, <span class="fl">0.005</span>, <span class="fl">0.026</span>, <span class="fl">0.018</span>, <span class="fl">0.039</span>, <span class="fl">0.062</span>, <span class="fl">0.012</span>,<span class="fl">0.132</span>, <span class="fl">0.02</span>, <span class="fl">0.138</span>, <span class="fl">0.065</span>, <span class="fl">0.005</span>, <span class="fl">0.013</span>, <span class="fl">0.101</span>, <span class="fl">0.051</span>, <span class="fl">0.011</span>, <span class="fl">0.018</span>, <span class="fl">0.012</span>,<span class="fl">0.059</span>, <span class="fl">0.111</span>, <span class="fl">0.073</span>, <span class="fl">0.047</span>, <span class="fl">0.01</span>, <span class="fl">0.007</span>, <span class="fl">0.055</span>, <span class="fl">0.019</span>, <span class="fl">0.104</span>, <span class="fl">0.056</span>, <span class="fl">0.006</span>,<span class="fl">0.094</span>, <span class="fl">0.009</span>, <span class="fl">0.008</span>, <span class="fl">0.02</span> )), </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># moderator values</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">xi =</span> <span class="fu">c</span>(<span class="fl">9.4</span>, <span class="fl">6.3</span>, <span class="fl">1.9</span>, <span class="fl">14.5</span>, <span class="fl">8.4</span>, <span class="fl">1.8</span>, <span class="fl">11.3</span>,<span class="fl">4.8</span>, <span class="fl">0.7</span>, <span class="fl">8.5</span>, <span class="dv">15</span>, <span class="fl">11.5</span>, <span class="fl">4.5</span>, <span class="fl">4.3</span>, <span class="fl">4.3</span>, <span class="fl">14.7</span>, <span class="fl">11.4</span>, <span class="fl">13.4</span>, <span class="fl">11.5</span>, <span class="fl">0.1</span>, <span class="fl">12.3</span>,<span class="fl">1.6</span>, <span class="fl">14.6</span>, <span class="fl">5.4</span>, <span class="fl">2.8</span>, <span class="fl">8.5</span>, <span class="fl">2.9</span>, <span class="fl">10.1</span>, <span class="fl">0.2</span>, <span class="fl">6.1</span>, <span class="dv">4</span>, <span class="fl">5.1</span>, <span class="fl">12.4</span>, <span class="fl">10.1</span>, <span class="fl">13.3</span>,<span class="fl">12.4</span>, <span class="fl">7.6</span>, <span class="fl">12.6</span>, <span class="dv">12</span>, <span class="fl">15.5</span>, <span class="fl">4.9</span>, <span class="fl">0.2</span>, <span class="fl">6.4</span>, <span class="fl">9.4</span>, <span class="fl">1.7</span>, <span class="fl">0.5</span>, <span class="fl">8.4</span>, <span class="fl">0.3</span>, <span class="fl">4.3</span>, <span class="fl">1.7</span>,<span class="fl">15.2</span>, <span class="fl">13.5</span>, <span class="fl">6.4</span>, <span class="fl">3.8</span>, <span class="fl">8.2</span>, <span class="fl">11.3</span>, <span class="fl">11.9</span>, <span class="fl">7.1</span>, <span class="dv">9</span>, <span class="fl">9.9</span>, <span class="fl">7.8</span>, <span class="fl">5.5</span>, <span class="fl">9.9</span>, <span class="fl">2.6</span>,<span class="fl">15.5</span>, <span class="fl">15.3</span>, <span class="fl">0.2</span>, <span class="fl">3.2</span>, <span class="fl">10.1</span>, <span class="dv">15</span>, <span class="fl">10.3</span>, <span class="dv">0</span>, <span class="fl">8.8</span>, <span class="fl">3.6</span>, <span class="dv">15</span>, <span class="fl">6.1</span>, <span class="fl">3.4</span>, <span class="fl">10.2</span>, <span class="fl">10.1</span>,<span class="fl">13.7</span>)), </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="st">"data.frame"</span>, <span class="at">row.names =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="sc">-</span><span class="dv">80</span>L))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     yi       sei   xi
1  0.99 0.1341641  9.4
2  0.54 0.2049390  6.3
3 -0.01 0.1760682  1.9
4  1.29 0.1483240 14.5
5  0.66 0.1264911  8.4
6 -0.12 0.1140175  1.8</code></pre>
</div>
</div>
<p>The effect size is denoted with <code>yi</code>, the standard errors are denoted with <code>sei</code>, and the study-level moderator values is denoted with <code>xi</code>.</p>
</section>
<section id="constructing-the-brms-model" class="level2">
<h2 class="anchored" data-anchor-id="constructing-the-brms-model">Constructing the <code>brms</code> model</h2>
<p>Using the <code>brm</code> function in the <code>brms</code> <span class="citation" data-cites="brms">(<a href="#ref-brms" role="doc-biblioref">Bürkner 2021</a>)</span> package we can construct the meta-regression GAM model by utilizing the <code>se()</code> argument to input the standard errors of the effect sizes. Then <code>s()</code> function to tell <code>brms</code> that we are fitting a GAM. The <code>sigma=TRUE</code> function allows us to have heterogeneity, that is, the model includes a <span class="math inline">\(\sigma\)</span> parameter which represents the standard deviation in true effects which we previously defined as <span class="math inline">\(\tau\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mdl_gam <span class="ot">&lt;-</span> <span class="fu">brm</span>(yi <span class="sc">|</span> <span class="fu">se</span>(sei, <span class="at">sigma =</span> <span class="cn">TRUE</span>) <span class="sc">~</span> <span class="fu">s</span>(xi),</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> dat, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">seed =</span> <span class="dv">17</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">iter =</span> <span class="dv">1000</span>, </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">warmup =</span> <span class="dv">150</span>, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">file =</span> <span class="st">"model_gam"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">file_refit =</span> <span class="st">"on_change"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s also construct a linear model so that we can compare the two fits.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mdl_lm <span class="ot">&lt;-</span> <span class="fu">brm</span>(yi <span class="sc">|</span> <span class="fu">se</span>(sei, <span class="at">sigma =</span> <span class="cn">TRUE</span>) <span class="sc">~</span> xi,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> dat, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">seed =</span> <span class="dv">17</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">iter =</span> <span class="dv">1000</span>, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">warmup =</span> <span class="dv">150</span>, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">file =</span> <span class="st">"model_lm"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">file_refit =</span> <span class="st">"on_change"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can plot out the models by displaying the estimates of the conditional effect size mean that are compatible with the data (denoted with the dark lines) and the conditional distribution of effect sizes (the density band with the bounds denoting the 95% prediction interval).</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract conditional mean estimates for GAM</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>gam_conditional_means <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data_grid</span>(<span class="at">xi =</span> <span class="fu">seq_range</span>(xi, <span class="at">n =</span> <span class="dv">101</span>), <span class="at">sei =</span> sei) <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_epred_draws</span>(mdl_gam, <span class="at">ndraws =</span> <span class="dv">200</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract true effect size predictions to construct true effect distribution for GAM</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>gam_predictions <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data_grid</span>(<span class="at">xi =</span> <span class="fu">seq_range</span>(xi, <span class="at">n =</span> <span class="dv">71</span>), <span class="at">sei =</span> sei) <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_predicted_draws</span>(mdl_gam, <span class="at">ndraws =</span> <span class="dv">400</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">data =</span> gam_predictions, </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> xi, <span class="at">y =</span> .prediction, <span class="at">fill_ramp =</span> <span class="fu">after_stat</span>(.width)),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">.width =</span> <span class="fu">seq</span>(.<span class="dv">05</span>,.<span class="dv">95</span>,<span class="at">by=</span>.<span class="dv">05</span>), <span class="at">fill =</span> <span class="st">"#ED5C9B"</span>) <span class="sc">+</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_ramp_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, .<span class="dv">1</span>), <span class="at">guide =</span> <span class="fu">guide_rampbar</span>(<span class="at">to =</span> <span class="st">"#ED5C9B"</span>)) <span class="sc">+</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> gam_conditional_means, </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> xi, <span class="at">y =</span> .epred, <span class="at">group =</span> .draw),<span class="at">color =</span> <span class="st">"#861d5e"</span>, <span class="at">alpha =</span> .<span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> dat, <span class="fu">aes</span>(<span class="at">x =</span> xi, <span class="at">y =</span> yi, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span>sei<span class="sc">^</span><span class="dv">2</span>), <span class="at">alpha =</span> .<span class="dv">8</span>, <span class="at">color =</span> <span class="st">"#601543"</span>) <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_ggdist</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype=</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#ED5C9B"</span>,<span class="at">alpha=</span>.<span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">aspect.ratio =</span> .<span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Effect Size"</span>) <span class="sc">+</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Moderator Value"</span>) <span class="sc">+</span> </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"GAM"</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract conditional mean estimates for GAM</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>lm_conditional_means <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data_grid</span>(<span class="at">xi =</span> <span class="fu">seq_range</span>(xi, <span class="at">n =</span> <span class="dv">101</span>), <span class="at">sei =</span> sei) <span class="sc">%&gt;%</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_epred_draws</span>(mdl_lm, <span class="at">ndraws =</span> <span class="dv">200</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract true effect size predictions to construct true effect distribution for GAM</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>lm_predictions <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data_grid</span>(<span class="at">xi =</span> <span class="fu">seq_range</span>(xi, <span class="at">n =</span> <span class="dv">51</span>), <span class="at">sei =</span> sei) <span class="sc">%&gt;%</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_predicted_draws</span>(mdl_lm, <span class="at">ndraws =</span> <span class="dv">200</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ribbon</span>(<span class="at">data =</span> lm_predictions, </span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> xi, <span class="at">y =</span> .prediction, <span class="at">fill_ramp =</span> <span class="fu">after_stat</span>(.width)),</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">.width =</span> <span class="fu">seq</span>(.<span class="dv">05</span>,.<span class="dv">95</span>,<span class="at">by=</span>.<span class="dv">05</span>), <span class="at">fill =</span> <span class="st">"#ED5C9B"</span>) <span class="sc">+</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_ramp_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, .<span class="dv">1</span>), <span class="at">guide =</span> <span class="fu">guide_rampbar</span>(<span class="at">to =</span> <span class="st">"#ED5C9B"</span>)) <span class="sc">+</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> lm_conditional_means, </span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> xi, <span class="at">y =</span> .epred, <span class="at">group =</span> .draw),<span class="at">color =</span> <span class="st">"#861d5e"</span>, <span class="at">alpha =</span> .<span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> dat, <span class="fu">aes</span>(<span class="at">x =</span> xi, <span class="at">y =</span> yi, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span>sei<span class="sc">^</span><span class="dv">2</span>), <span class="at">alpha =</span> .<span class="dv">8</span>, <span class="at">color =</span> <span class="st">"#601543"</span>) <span class="sc">+</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_ggdist</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype=</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#ED5C9B"</span>,<span class="at">alpha=</span>.<span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">aspect.ratio =</span> .<span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Effect Size"</span>) <span class="sc">+</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Moderator Value"</span>) <span class="sc">+</span> </span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"GAM"</span>)</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(p1,p2,<span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="blog-post-8_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="predictive-check" class="level2">
<h2 class="anchored" data-anchor-id="predictive-check">Predictive Check</h2>
<p>The predictive check of the GAM model captures the data better than the linear model in this data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>pp1 <span class="ot">&lt;-</span> <span class="fu">pp_check</span>(mdl_gam, <span class="at">ndraws =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">aspect.ratio =</span> <span class="dv">1</span>, <span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"GAM"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>pp2 <span class="ot">&lt;-</span> <span class="fu">pp_check</span>(mdl_lm, <span class="at">ndraws =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">aspect.ratio =</span> <span class="dv">1</span>, <span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Linear Model"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(pp1,pp2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="blog-post-8_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="session-info" class="level2">
<h2 class="anchored" data-anchor-id="session-info">Session Info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.2 (2024-10-31)
Platform: aarch64-apple-darwin20
Running under: macOS Sonoma 14.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/New_York
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices datasets  utils     methods   base     

other attached packages:
 [1] ggdist_3.3.2        modelr_0.1.11       tidybayes_3.0.7    
 [4] mgcv_1.9-1          nlme_3.1-166        brms_2.22.0        
 [7] Rcpp_1.0.12         lubridate_1.9.3     forcats_1.0.0      
[10] stringr_1.5.1       dplyr_1.1.4         purrr_1.0.2        
[13] readr_2.1.5         tidyr_1.3.1         tibble_3.2.1       
[16] ggplot2_3.5.1       tidyverse_2.0.0     metafor_4.6-0      
[19] numDeriv_2016.8-1.1 metadat_1.2-0       Matrix_1.7-1       

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1     svUnit_1.0.6         viridisLite_0.4.2   
 [4] farver_2.1.2         loo_2.8.0            fastmap_1.2.0       
 [7] tensorA_0.36.2.1     mathjaxr_1.6-0       digest_0.6.36       
[10] timechange_0.3.0     lifecycle_1.0.4      StanHeaders_2.32.10 
[13] magrittr_2.0.3       posterior_1.6.0      compiler_4.4.2      
[16] rlang_1.1.4          tools_4.4.2          utf8_1.2.4          
[19] yaml_2.3.8           knitr_1.47           labeling_0.4.3      
[22] bridgesampling_1.1-2 htmlwidgets_1.6.4    pkgbuild_1.4.4      
[25] plyr_1.8.9           abind_1.4-8          withr_3.0.0         
[28] grid_4.4.2           stats4_4.4.2         fansi_1.0.6         
[31] colorspace_2.1-0     inline_0.3.19        scales_1.3.0        
[34] cli_3.6.3            mvtnorm_1.3-1        rmarkdown_2.27      
[37] generics_0.1.3       RcppParallel_5.1.9   rstudioapi_0.16.0   
[40] reshape2_1.4.4       tzdb_0.4.0           rstan_2.32.6        
[43] splines_4.4.2        bayesplot_1.11.1     parallel_4.4.2      
[46] matrixStats_1.4.1    vctrs_0.6.5          jsonlite_1.8.8      
[49] hms_1.1.3            arrayhelpers_1.1-0   glue_1.7.0          
[52] codetools_0.2-20     cowplot_1.1.3        distributional_0.4.0
[55] stringi_1.8.4        gtable_0.3.5         QuickJSR_1.3.1      
[58] munsell_0.5.1        pillar_1.9.0         htmltools_0.5.8.1   
[61] Brobdingnag_1.2-9    R6_2.5.1             evaluate_0.24.0     
[64] lattice_0.22-6       backports_1.5.0      broom_1.0.6         
[67] renv_0.17.3          rstantools_2.4.0     coda_0.19-4.1       
[70] gridExtra_2.3        checkmate_2.3.1      xfun_0.45           
[73] pkgconfig_2.0.3     </code></pre>
</div>
</div>
</section>
<section id="citing-r-packages" class="level2">
<h2 class="anchored" data-anchor-id="citing-r-packages">Citing R packages</h2>
<p>The following packages were used in this post:</p>
<ul>
<li><code>brms</code> <span class="citation" data-cites="brms">(<a href="#ref-brms" role="doc-biblioref">Bürkner 2021</a>)</span></li>
<li><code>mgcv</code> <span class="citation" data-cites="splines">(<a href="#ref-splines" role="doc-biblioref">R Core Team 2024</a>)</span></li>
<li><code>tidyverse</code> <span class="citation" data-cites="tidyverse">(<a href="#ref-tidyverse" role="doc-biblioref">Wickham et al. 2019</a>)</span></li>
<li><code>ggdist</code> <span class="citation" data-cites="ggdist">(<a href="#ref-ggdist" role="doc-biblioref">Kay 2023</a>)</span></li>
<li><code>modelr</code> <span class="citation" data-cites="modelr">(<a href="#ref-modelr" role="doc-biblioref">Wickham 2023</a>)</span></li>
<li><code>tidybayes</code> <span class="citation" data-cites="tidybayes">(<a href="#ref-tidybayes" role="doc-biblioref">Kay 2024</a>)</span></li>
</ul>
<p><strong>Thanks to Isabella R. Ghement, Stephen J. Wild, and Solomon Kurz for their advice and feedback on this post.</strong></p>
<iframe src="https://embeds.beehiiv.com/f3ffd81a-4723-4419-bb1d-afc8af3bac36" data-test-id="beehiiv-embed" width="100%" height="320" frameborder="0" scrolling="no" style="border-radius: 4px; border: 2px solid #33333322; margin: 0; background-color: transparent;">
</iframe>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-brms" class="csl-entry" role="listitem">
Bürkner, Paul-Christian. 2021. <span>“Bayesian Item Response Modeling in <span>R</span> with <span class="nocase">brms</span> and <span>Stan</span>.”</span> <em>Journal of Statistical Software</em> 100 (5): 1–54. <a href="https://doi.org/10.18637/jss.v100.i05">https://doi.org/10.18637/jss.v100.i05</a>.
</div>
<div id="ref-ggdist" class="csl-entry" role="listitem">
Kay, Matthew. 2023. <span>“Ggdist: Visualizations of Distributions and Uncertainty in the Grammar of Graphics.”</span> <a href="https://doi.org/10.31219/osf.io/2gsz6">https://doi.org/10.31219/osf.io/2gsz6</a>.
</div>
<div id="ref-tidybayes" class="csl-entry" role="listitem">
———. 2024. <em><span class="nocase">tidybayes</span>: Tidy Data and Geoms for <span>Bayesian</span> Models</em>. <a href="https://doi.org/10.5281/zenodo.1308151">https://doi.org/10.5281/zenodo.1308151</a>.
</div>
<div id="ref-splines" class="csl-entry" role="listitem">
R Core Team. 2024. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-metafor" class="csl-entry" role="listitem">
Viechtbauer, Wolfgang. 2010. <span>“Conducting Meta-Analyses in <span>R</span> with the <span class="nocase">metafor</span> Package.”</span> <em>Journal of Statistical Software</em> 36 (3): 1–48. <a href="https://doi.org/10.18637/jss.v036.i03">https://doi.org/10.18637/jss.v036.i03</a>.
</div>
<div id="ref-modelr" class="csl-entry" role="listitem">
Wickham, Hadley. 2023. <em>Modelr: Modelling Functions That Work with the Pipe</em>. <a href="https://CRAN.R-project.org/package=modelr">https://CRAN.R-project.org/package=modelr</a>.
</div>
<div id="ref-tidyverse" class="csl-entry" role="listitem">
Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the <span class="nocase">tidyverse</span>.”</span> <em>Journal of Open Source Software</em> 4 (43): 1686. <a href="https://doi.org/10.21105/joss.01686">https://doi.org/10.21105/joss.01686</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/matthewbjane\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Email me at matthew.jane@uconn.edu</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>